<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Âπ∏ËøêÊé∑È™∞Â≠ê</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --bg-light: radial-gradient(circle at 20% 15%, #fef3c7 0%, #ede9fe 34%, #dbeafe 68%, #f8fafc 100%);
            --bg-dark: radial-gradient(circle at 20% 10%, #172554 0%, #111827 40%, #020617 100%);
            --glass-light: rgba(255, 255, 255, 0.84);
            --glass-dark: rgba(15, 23, 42, 0.86);
            --text-light: #111827;
            --text-dark: #f8fafc;
            --muted-light: #4b5563;
            --muted-dark: #cbd5e1;
            --accent: #2563eb;
            --accent-strong: #1d4ed8;
            --card-radius: 2rem;
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.24s ease, color 0.24s ease, border-color 0.24s ease, transform 0.24s ease;
        }

        body {
            margin: 0;
            min-height: 100dvh;
            font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", "Hiragino Sans GB", sans-serif;
            background: var(--bg-light);
            color: var(--text-light);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .dark-mode {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .bg-pattern {
            position: absolute;
            inset: 0;
            opacity: 0.25;
            background-image:
                linear-gradient(30deg, rgba(59, 130, 246, 0.12) 12%, transparent 12.5%, transparent 87%, rgba(59, 130, 246, 0.12) 87.5%, rgba(59, 130, 246, 0.12)),
                linear-gradient(150deg, rgba(99, 102, 241, 0.12) 12%, transparent 12.5%, transparent 87%, rgba(99, 102, 241, 0.12) 87.5%, rgba(99, 102, 241, 0.12));
            background-size: 72px 42px;
            pointer-events: none;
        }

        #stars-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.24s ease;
        }

        .dark-mode #stars-container {
            opacity: 1;
        }

        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: #e2e8f0;
            animation: twinkle 3.8s infinite;
            box-shadow: 0 0 8px rgba(226, 232, 240, 0.8);
        }

        @keyframes twinkle {
            0%,
            100% {
                opacity: 0.25;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.25);
            }
        }

        .app-shell {
            position: relative;
            z-index: 2;
            width: min(440px, calc(100vw - 1rem));
            min-height: min(790px, calc(100dvh - 1rem));
            max-height: calc(100dvh - 1rem);
            border-radius: var(--card-radius);
            padding: calc(1rem + var(--safe-top)) 1rem calc(1rem + var(--safe-bottom));
            background: var(--glass-light);
            backdrop-filter: blur(22px);
            border: 1px solid rgba(255, 255, 255, 0.45);
            box-shadow: 0 24px 60px rgba(30, 41, 59, 0.2);
            display: flex;
            flex-direction: column;
            gap: clamp(0.45rem, 1.25vh, 0.9rem);
            overflow: hidden;
        }

        .dark-mode .app-shell {
            background: var(--glass-dark);
            border-color: rgba(148, 163, 184, 0.25);
            box-shadow: 0 26px 58px rgba(2, 6, 23, 0.7);
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 2.25rem;
            text-align: center;
        }

        .app-title {
            margin: 0;
            font-size: clamp(1.35rem, 2.6vw, 1.7rem);
            line-height: 1.05;
            font-weight: 900;
            letter-spacing: 0.03em;
            color: var(--text-light);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .dark-mode .app-title {
            color: var(--text-dark);
        }

        .title-dice {
            font-size: 1.6rem;
            filter: drop-shadow(0 3px 6px rgba(37, 99, 235, 0.32));
        }

        .control-bar {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.45rem;
        }

        .icon-btn {
            height: 2.35rem;
            width: 100%;
            border-radius: 0.9rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(248, 250, 252, 0.85);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #334155;
            padding: 0;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }

        .icon-btn:hover {
            transform: translateY(-1px);
            border-color: rgba(37, 99, 235, 0.42);
        }

        .icon-btn:active {
            transform: translateY(0);
        }

        .icon-btn.is-active {
            border-color: rgba(37, 99, 235, 0.62);
            box-shadow: 0 6px 14px rgba(37, 99, 235, 0.22);
            color: #1d4ed8;
            background: rgba(219, 234, 254, 0.9);
        }

        .dark-mode .icon-btn {
            border-color: rgba(148, 163, 184, 0.3);
            background: rgba(30, 41, 59, 0.82);
            color: #e2e8f0;
            box-shadow: 0 4px 12px rgba(2, 6, 23, 0.35);
        }

        .dark-mode .icon-btn:hover {
            border-color: rgba(96, 165, 250, 0.7);
        }

        .dark-mode .icon-btn.is-active {
            background: rgba(30, 64, 175, 0.36);
            color: #bfdbfe;
            border-color: rgba(96, 165, 250, 0.8);
        }

        .icon-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.1rem;
            height: 1.1rem;
        }

        .icon-slot svg {
            width: 100%;
            height: 100%;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.9;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .voice-panel {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            border-radius: 1rem;
            border: 1px solid transparent;
            pointer-events: none;
        }

        .voice-panel.open {
            max-height: 190px;
            opacity: 1;
            pointer-events: auto;
            border-color: rgba(148, 163, 184, 0.25);
            background: rgba(248, 250, 252, 0.78);
        }

        .dark-mode .voice-panel.open {
            background: rgba(30, 41, 59, 0.72);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .voice-panel-content {
            padding: 0.75rem;
            display: grid;
            gap: 0.55rem;
        }

        .panel-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #334155;
        }

        .dark-mode .panel-title-row {
            color: #e2e8f0;
        }

        .panel-title-row strong {
            font-size: 0.82rem;
            font-weight: 800;
            letter-spacing: 0.03em;
        }

        .voice-select {
            width: 100%;
            border-radius: 0.8rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(255, 255, 255, 0.95);
            color: #1f2937;
            font-size: 0.86rem;
            padding: 0.58rem 0.72rem;
            outline: none;
        }

        .dark-mode .voice-select {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
            border-color: rgba(148, 163, 184, 0.35);
        }

        .test-btn {
            border: none;
            border-radius: 0.62rem;
            padding: 0.37rem 0.6rem;
            font-size: 0.74rem;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            cursor: pointer;
        }

        .voice-preview {
            margin: 0;
            font-size: 0.75rem;
            color: var(--muted-light);
            text-align: center;
        }

        .dark-mode .voice-preview {
            color: var(--muted-dark);
        }

        .count-switch {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.34rem;
            background: rgba(226, 232, 240, 0.55);
            padding: 0.34rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .dark-mode .count-switch {
            background: rgba(30, 41, 59, 0.66);
            border-color: rgba(148, 163, 184, 0.24);
        }

        .count-label {
            cursor: pointer;
        }

        .count-label input {
            display: none;
        }

        .count-option {
            text-align: center;
            font-size: 0.86rem;
            font-weight: 800;
            border-radius: 0.75rem;
            padding: 0.5rem 0.35rem;
            color: #475569;
            border: 1px solid transparent;
        }

        .dark-mode .count-option {
            color: #cbd5e1;
        }

        .count-label input:checked + .count-option {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 7px 14px rgba(37, 99, 235, 0.28);
        }

        .dice-container-3d {
            perspective: 1000px;
            min-height: clamp(120px, 18dvh, 160px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(0.75rem, 3vw, 1.8rem);
        }

        .dice {
            width: clamp(5.5rem, 13vw, 7rem);
            height: clamp(5.5rem, 13vw, 7rem);
            background: linear-gradient(145deg, #ffffff, #e2e8f0);
            border-radius: 1.3rem;
            position: relative;
            box-shadow:
                0 18px 34px rgba(15, 23, 42, 0.15),
                0 6px 16px rgba(30, 41, 59, 0.1),
                inset 0 -6px 10px rgba(15, 23, 42, 0.07),
                inset 0 7px 12px rgba(255, 255, 255, 0.82);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 10%;
            gap: 6%;
            transform-style: preserve-3d;
        }

        .dark-mode .dice {
            background: linear-gradient(145deg, #334155, #1e293b);
            box-shadow:
                0 18px 34px rgba(2, 6, 23, 0.65),
                0 6px 16px rgba(2, 6, 23, 0.45),
                inset 0 -6px 10px rgba(2, 6, 23, 0.38),
                inset 0 7px 12px rgba(255, 255, 255, 0.08);
        }

        .dot {
            background: radial-gradient(circle at 35% 35%, #64748b, #1e293b);
            border-radius: 999px;
            width: 100%;
            height: 100%;
            box-shadow:
                inset 0 3px 6px rgba(2, 6, 23, 0.48),
                0 2px 4px rgba(255, 255, 255, 0.58),
                0 3px 6px rgba(2, 6, 23, 0.25);
        }

        .dark-mode .dot {
            background: radial-gradient(circle at 35% 35%, #cbd5e1, #475569);
        }

        .dot-tl {
            grid-area: 1 / 1 / 2 / 2;
        }

        .dot-tr {
            grid-area: 1 / 3 / 2 / 4;
        }

        .dot-ml {
            grid-area: 2 / 1 / 3 / 2;
        }

        .dot-mc {
            grid-area: 2 / 2 / 3 / 3;
        }

        .dot-mr {
            grid-area: 2 / 3 / 3 / 4;
        }

        .dot-bl {
            grid-area: 3 / 1 / 4 / 2;
        }

        .dot-br {
            grid-area: 3 / 3 / 4 / 4;
        }

        @keyframes shake {
            0% {
                transform: rotate(0deg) translate(0, 0) scale(1);
            }

            20% {
                transform: rotate(-14deg) translate(-5px, -3px) scale(1.05);
            }

            40% {
                transform: rotate(10deg) translate(5px, 2px) scale(1.03);
            }

            60% {
                transform: rotate(-9deg) translate(-4px, 4px) scale(1.02);
            }

            80% {
                transform: rotate(6deg) translate(3px, -3px) scale(1.01);
            }

            100% {
                transform: rotate(0deg) translate(0, 0) scale(1);
            }
        }

        .shake {
            animation: shake 0.14s infinite;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0.45);
                opacity: 0;
            }

            60% {
                transform: scale(1.08);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .bounce-in {
            animation: bounce-in 0.48s cubic-bezier(0.66, -0.56, 0.33, 1.4);
        }

        .result-wrapper {
            display: flex;
            justify-content: center;
        }

        .result-box {
            min-width: 66%;
            text-align: center;
            border-radius: 1rem;
            border: 2px solid rgba(37, 99, 235, 0.34);
            background: rgba(239, 246, 255, 0.78);
            padding: 0.55rem 0.85rem;
            box-shadow: 0 10px 22px rgba(37, 99, 235, 0.13);
        }

        .dark-mode .result-box {
            background: rgba(30, 64, 175, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }

        .result-text {
            margin: 0;
            font-size: clamp(1.25rem, 3.6vw, 1.65rem);
            font-weight: 900;
            letter-spacing: 0.02em;
            color: #1f2937;
        }

        .dark-mode .result-text {
            color: #f8fafc;
        }

        .roll-button {
            border: none;
            border-radius: 1rem;
            padding: 0.78rem 1rem;
            font-size: 1.05rem;
            font-weight: 900;
            color: #fff;
            background: linear-gradient(135deg, #2563eb, #1e3a8a);
            cursor: pointer;
            box-shadow: 0 14px 24px rgba(37, 99, 235, 0.32);
            position: relative;
            overflow: hidden;
        }

        .roll-button::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(110deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
            transform: translateX(-120%);
            transition: transform 0.55s ease;
        }

        .roll-button:hover::before {
            transform: translateX(120%);
        }

        .roll-button:active {
            transform: scale(0.98);
        }

        .roll-button:disabled {
            opacity: 0.65;
            cursor: not-allowed;
            transform: none;
        }

        .stats-trigger {
            border: none;
            border-radius: 0.9rem;
            padding: 0.52rem 0.78rem;
            font-size: 0.83rem;
            font-weight: 700;
            color: #1d4ed8;
            background: rgba(219, 234, 254, 0.75);
            border: 1px solid rgba(37, 99, 235, 0.26);
            cursor: pointer;
        }

        .stats-trigger:hover {
            background: rgba(191, 219, 254, 0.88);
        }

        .dark-mode .stats-trigger {
            color: #bfdbfe;
            background: rgba(30, 64, 175, 0.2);
            border-color: rgba(96, 165, 250, 0.35);
        }

        .stats-modal {
            position: fixed;
            inset: 0;
            z-index: 20;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            background: rgba(2, 6, 23, 0.48);
            opacity: 0;
            pointer-events: none;
        }

        .stats-modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .stats-card {
            width: min(520px, calc(100vw - 1.2rem));
            margin: 0.6rem;
            border-radius: 1.15rem;
            background: #ffffff;
            color: #1f2937;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 18px 42px rgba(15, 23, 42, 0.32);
            padding: 0.85rem;
            transform: translateY(18px);
            transition: transform 0.24s ease;
        }

        .dark-mode .stats-card {
            background: #0f172a;
            color: #e2e8f0;
            border-color: rgba(148, 163, 184, 0.3);
        }

        .stats-modal.open .stats-card {
            transform: translateY(0);
        }

        .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.3rem;
        }

        .stats-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 900;
        }

        .mini-btn {
            border: none;
            border-radius: 0.65rem;
            padding: 0.34rem 0.6rem;
            font-size: 0.74rem;
            font-weight: 700;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(135deg, #334155, #0f172a);
        }

        .mini-btn.secondary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .stats-summary {
            margin: 0.1rem 0 0.72rem;
            font-size: 0.78rem;
            color: #64748b;
        }

        .dark-mode .stats-summary {
            color: #94a3b8;
        }

        .stats-chart {
            height: 180px;
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            gap: 0.35rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            gap: 0.2rem;
        }

        .stat-count {
            font-size: 0.68rem;
            font-weight: 700;
            color: #1d4ed8;
            min-height: 0.82rem;
        }

        .dark-mode .stat-count {
            color: #93c5fd;
        }

        .stat-track {
            width: 100%;
            height: 128px;
            border-radius: 0.5rem;
            background: linear-gradient(180deg, rgba(203, 213, 225, 0.32), rgba(203, 213, 225, 0.56));
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }

        .dark-mode .stat-track {
            background: linear-gradient(180deg, rgba(51, 65, 85, 0.45), rgba(51, 65, 85, 0.9));
        }

        .stat-bar {
            width: 100%;
            min-height: 4px;
            border-radius: 0.5rem 0.5rem 0 0;
            background: linear-gradient(180deg, #60a5fa, #1d4ed8);
            transform-origin: bottom;
            box-shadow: 0 5px 10px rgba(37, 99, 235, 0.35);
        }

        .stat-label {
            font-size: 0.68rem;
            font-weight: 700;
            color: #334155;
        }

        .dark-mode .stat-label {
            color: #cbd5e1;
        }

        .stats-actions {
            margin-top: 0.78rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.45rem;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                align-items: stretch;
                justify-content: flex-start;
            }

            .app-shell {
                width: 100vw;
                min-height: 100dvh;
                max-height: 100dvh;
                max-width: none;
                border-radius: 0;
                margin: 0;
                padding: calc(0.78rem + var(--safe-top)) 0.8rem calc(0.86rem + var(--safe-bottom));
                box-shadow: none;
                border-width: 0;
                gap: 0.5rem;
            }

            .app-title {
                font-size: 1.32rem;
            }

            .icon-btn {
                height: 2.2rem;
                border-radius: 0.78rem;
            }

            .voice-panel.open {
                max-height: 168px;
            }

            .dice-container-3d {
                min-height: clamp(102px, 17dvh, 128px);
            }

            .result-box {
                min-width: 74%;
                padding: 0.46rem 0.72rem;
            }

            .roll-button {
                padding: 0.72rem 0.9rem;
            }

            .stats-card {
                width: calc(100vw - 0.8rem);
                margin: 0.4rem;
                border-radius: 0.9rem;
            }

            .stats-chart {
                gap: 0.24rem;
            }
        }
    </style>
</head>

<body>
    <div class="bg-pattern"></div>
    <div id="stars-container"></div>

    <main class="app-shell" id="app-shell">
        <header class="app-header">
            <h1 class="app-title"><span class="title-dice">üé≤</span>Âπ∏ËøêÊé∑È™∞Â≠ê</h1>
        </header>

        <section class="control-bar">
            <button id="sound-toggle" class="icon-btn" onclick="toggleSound()" title="Èü≥ÊïàÂºÄÂÖ≥" aria-label="Èü≥ÊïàÂºÄÂÖ≥">
                <span id="sound-icon" class="icon-slot"></span>
            </button>
            <button id="voice-toggle" class="icon-btn" onclick="toggleVoice()" title="ËØ≠Èü≥Êí≠Êä•ÂºÄÂÖ≥" aria-label="ËØ≠Èü≥Êí≠Êä•ÂºÄÂÖ≥">
                <span id="voice-icon" class="icon-slot"></span>
            </button>
            <button id="voice-settings-toggle" class="icon-btn" onclick="toggleVoicePanel()" title="ËØ≠Èü≥Êí≠Êä•ËÆæÁΩÆ" aria-label="ËØ≠Èü≥Êí≠Êä•ËÆæÁΩÆ">
                <span id="voice-settings-icon" class="icon-slot"></span>
            </button>
            <button id="theme-toggle" class="icon-btn" onclick="toggleTheme()" title="ÊµÖËâ≤ÊàñÊ∑±Ëâ≤Ê®°Âºè" aria-label="ÊµÖËâ≤ÊàñÊ∑±Ëâ≤Ê®°Âºè">
                <span id="theme-icon" class="icon-slot"></span>
            </button>
            <button id="fullscreen-toggle" class="icon-btn" onclick="toggleFullscreen()" title="ÂÖ®Â±èÊòæÁ§∫ÊàñÈÄÄÂá∫" aria-label="ÂÖ®Â±èÊòæÁ§∫ÊàñÈÄÄÂá∫">
                <span id="fullscreen-icon" class="icon-slot"></span>
            </button>
        </section>

        <section id="voice-panel" class="voice-panel">
            <div class="voice-panel-content">
                <div class="panel-title-row">
                    <strong>ËØ≠Èü≥Èü≥Ëâ≤Â∫ìÔºàÂ•≥Â£∞ 5 + Áî∑Â£∞ 5Ôºâ</strong>
                    <button class="test-btn" onclick="testVoice()">ËØïÂê¨</button>
                </div>
                <select id="voice-select" class="voice-select" onchange="changeVoice()"></select>
                <p id="voice-preview" class="voice-preview">ÂΩìÂâçÈü≥Ëâ≤: Â•≥Â£∞-ËΩªÊüî</p>
            </div>
        </section>

        <section class="count-switch" aria-label="È™∞Â≠êÊï∞ÈáèÈÄâÊã©">
            <label class="count-label">
                <input type="radio" name="diceCount" value="1" checked onchange="handleCountChange(event)">
                <div class="count-option">1 ‰∏™È™∞Â≠ê</div>
            </label>
            <label class="count-label">
                <input type="radio" name="diceCount" value="2" onchange="handleCountChange(event)">
                <div class="count-option">2 ‰∏™È™∞Â≠ê</div>
            </label>
        </section>

        <section class="dice-container-3d" id="dice-container">
            <div id="dice1" class="dice"></div>
            <div id="dice2" class="dice hidden"></div>
        </section>

        <section class="result-wrapper">
            <div id="result-box" class="result-box">
                <p id="result-text" class="result-text">ÊÄªËÆ°: 1 ÁÇπ</p>
            </div>
        </section>

        <button id="roll-button" class="roll-button" onclick="rollDice()">üé≤ ÂºÄÂßãÊäïÊé∑</button>

        <button id="stats-trigger" class="stats-trigger" onclick="toggleStatsModal(true)">ÊäïÊé∑ÁÇπÊï∞ÂàÜÂ∏ÉÔºàÁÇπÂáªÊü•ÁúãÔºâ</button>
    </main>

    <div id="stats-modal" class="stats-modal" aria-hidden="true">
        <div class="stats-card">
            <div class="stats-header">
                <h2>ÊäïÊé∑ÁÇπÊï∞ÂàÜÂ∏ÉÁªüËÆ°</h2>
                <button class="mini-btn" onclick="toggleStatsModal(false)">ÂÖ≥Èó≠</button>
            </div>
            <p id="stats-summary" class="stats-summary">ÊöÇÊó†ÊäïÊé∑Êï∞ÊçÆÔºåÂºÄÂßãÊäïÊé∑Âêé‰ºöËá™Âä®ÁªüËÆ°„ÄÇ</p>
            <div id="stats-chart" class="stats-chart"></div>
            <div class="stats-actions">
                <button class="mini-btn secondary" onclick="resetStats()">ÈáçÁΩÆÁªüËÆ°ÁªìÊûú</button>
            </div>
        </div>
    </div>

    <script>
        const voiceProfiles = [
            {
                label: "Â•≥Â£∞-ËΩªÊüî",
                gender: "female",
                rate: 0.92,
                pitch: 1.35,
                volume: 1,
                keywords: ["xiaoxiao", "tingting", "female", "siri"]
            },
            {
                label: "Â•≥Â£∞-Êòé‰∫Æ",
                gender: "female",
                rate: 1.02,
                pitch: 1.27,
                volume: 1,
                keywords: ["yaoyao", "xiao", "huihui", "he"]
            },
            {
                label: "Â•≥Â£∞-ÁîúÁæé",
                gender: "female",
                rate: 1.1,
                pitch: 1.42,
                volume: 1,
                keywords: ["xiaoyi", "ting", "sunhi", "hanna"]
            },
            {
                label: "Â•≥Â£∞-Ê∏ÖÊô∞",
                gender: "female",
                rate: 0.98,
                pitch: 1.2,
                volume: 1,
                keywords: ["hui", "mei", "luna", "female"]
            },
            {
                label: "Â•≥Â£∞-Ê≤âÁ®≥",
                gender: "female",
                rate: 0.9,
                pitch: 1.08,
                volume: 1,
                keywords: ["xiaorui", "xiaoqiu", "victoria", "wen"]
            },
            {
                label: "Áî∑Â£∞-Ê∏©Ê∂¶",
                gender: "male",
                rate: 0.93,
                pitch: 0.95,
                volume: 1,
                keywords: ["kangkang", "yunxi", "male", "siri"]
            },
            {
                label: "Áî∑Â£∞-Á£ÅÊÄß",
                gender: "male",
                rate: 0.88,
                pitch: 0.82,
                volume: 1,
                keywords: ["kang", "junjie", "xiaobei", "david"]
            },
            {
                label: "Áî∑Â£∞-Ê∏ÖÊúó",
                gender: "male",
                rate: 1.02,
                pitch: 0.98,
                volume: 1,
                keywords: ["yunyang", "yunjian", "tom", "alex"]
            },
            {
                label: "Áî∑Â£∞-‰ΩéÊ≤â",
                gender: "male",
                rate: 0.86,
                pitch: 0.74,
                volume: 1,
                keywords: ["yunze", "sam", "lee", "male"]
            },
            {
                label: "Áî∑Â£∞-Êí≠Èü≥",
                gender: "male",
                rate: 0.95,
                pitch: 0.88,
                volume: 1,
                keywords: ["yunhao", "bo", "liam", "zhong"]
            }
        ];

        const state = {
            diceCount: 1,
            isRolling: false,
            dice1Value: 1,
            dice2Value: 1,
            shakePermissionGranted: false,
            soundEnabled: true,
            voiceEnabled: true,
            isDarkMode: false,
            lastShakeTime: 0,
            selectedProfileIndex: 0,
            availableVoices: [],
            distribution: Array.from({ length: 13 }, () => 0),
            rollingSoundTimer: null,
            isFullscreen: false
        };

        const dom = {
            dice1: document.getElementById("dice1"),
            dice2: document.getElementById("dice2"),
            resultText: document.getElementById("result-text"),
            resultBox: document.getElementById("result-box"),
            rollButton: document.getElementById("roll-button"),
            soundIcon: document.getElementById("sound-icon"),
            voiceIcon: document.getElementById("voice-icon"),
            themeIcon: document.getElementById("theme-icon"),
            fullscreenIcon: document.getElementById("fullscreen-icon"),
            voiceSettingsIcon: document.getElementById("voice-settings-icon"),
            voicePanel: document.getElementById("voice-panel"),
            voiceSelect: document.getElementById("voice-select"),
            voicePreview: document.getElementById("voice-preview"),
            statsModal: document.getElementById("stats-modal"),
            statsChart: document.getElementById("stats-chart"),
            statsSummary: document.getElementById("stats-summary"),
            starsContainer: document.getElementById("stars-container"),
            soundButton: document.getElementById("sound-toggle"),
            voiceButton: document.getElementById("voice-toggle"),
            voiceSettingsButton: document.getElementById("voice-settings-toggle"),
            themeButton: document.getElementById("theme-toggle"),
            fullscreenButton: document.getElementById("fullscreen-toggle")
        };

        const ICONS = {
            soundOn: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M11 5 6.6 9H3v6h3.6L11 19V5Z"></path><path d="M15 9.5a4 4 0 0 1 0 5"></path><path d="M17.9 7a7.3 7.3 0 0 1 0 10"></path></svg>`,
            soundOff: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M11 5 6.6 9H3v6h3.6L11 19V5Z"></path><path d="m15 9.5 4 5"></path><path d="m19 9.5-4 5"></path></svg>`,
            voiceOn: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="9" y="3" width="6" height="11" rx="3"></rect><path d="M6 11a6 6 0 0 0 12 0"></path><path d="M12 17v4"></path><path d="M9 21h6"></path></svg>`,
            voiceOff: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="9" y="3" width="6" height="11" rx="3"></rect><path d="m4 4 16 16"></path><path d="M6 11a6 6 0 0 0 6 6"></path></svg>`,
            settings: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h11"></path><path d="M18 7h2"></path><circle cx="16" cy="7" r="2"></circle><path d="M4 17h4"></path><path d="M11 17h9"></path><circle cx="9" cy="17" r="2"></circle></svg>`,
            moon: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 14.5A8.2 8.2 0 1 1 9.5 4a7 7 0 0 0 10.5 10.5Z"></path></svg>`,
            sun: `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="3.8"></circle><path d="M12 2v3"></path><path d="M12 19v3"></path><path d="m4.9 4.9 2.1 2.1"></path><path d="m17 17 2.1 2.1"></path><path d="M2 12h3"></path><path d="M19 12h3"></path><path d="m4.9 19.1 2.1-2.1"></path><path d="m17 7 2.1-2.1"></path></svg>`,
            fullscreenEnter: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 3H3v5"></path><path d="M16 3h5v5"></path><path d="M3 16v5h5"></path><path d="M21 16v5h-5"></path></svg>`,
            fullscreenExit: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 9H3V3"></path><path d="M15 9h6V3"></path><path d="M3 21v-6h6"></path><path d="M21 21v-6h-6"></path></svg>`
        };

        const diceFaces = {
            1: ["dot-mc"],
            2: ["dot-tl", "dot-br"],
            3: ["dot-tl", "dot-mc", "dot-br"],
            4: ["dot-tl", "dot-tr", "dot-bl", "dot-br"],
            5: ["dot-tl", "dot-tr", "dot-mc", "dot-bl", "dot-br"],
            6: ["dot-tl", "dot-tr", "dot-ml", "dot-mr", "dot-bl", "dot-br"]
        };

        let audioContext = null;

        function normalizeText(text) {
            return String(text || "").toLowerCase();
        }

        function detectVoiceGender(voice) {
            const text = normalizeText(`${voice.name} ${voice.lang}`);
            if (/female|woman|girl|Â•≥|xiao|ting|yao|hui|mei/.test(text)) {
                return "female";
            }
            if (/male|man|boy|Áî∑|kang|yun|lee|tom|david|alex|sam|liam/.test(text)) {
                return "male";
            }
            return null;
        }

        function chooseVoiceForProfile(profile, pool, usedNames) {
            if (!pool.length) return null;

            const profileKeywords = profile.keywords.map(normalizeText);
            let picked = pool.find((voice) => {
                const voiceText = normalizeText(`${voice.name} ${voice.lang}`);
                return profileKeywords.some((keyword) => voiceText.includes(keyword)) && !usedNames.has(voice.name);
            });

            if (!picked) {
                picked = pool.find((voice) => detectVoiceGender(voice) === profile.gender && !usedNames.has(voice.name));
            }

            if (!picked) {
                picked = pool.find((voice) => !usedNames.has(voice.name));
            }

            if (!picked) {
                picked = pool[0];
            }

            return picked;
        }

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playRollChunk() {
            if (!state.soundEnabled) return;
            try {
                const ctx = initAudioContext();
                const now = ctx.currentTime;
                const oscillator = ctx.createOscillator();
                const filter = ctx.createBiquadFilter();
                const gainNode = ctx.createGain();

                oscillator.type = "triangle";
                oscillator.frequency.setValueAtTime(120 + Math.random() * 90, now);
                oscillator.frequency.exponentialRampToValueAtTime(70 + Math.random() * 60, now + 0.08);

                filter.type = "bandpass";
                filter.frequency.setValueAtTime(550 + Math.random() * 700, now);
                filter.Q.value = 6;

                gainNode.gain.setValueAtTime(0.0001, now);
                gainNode.gain.exponentialRampToValueAtTime(0.16, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.08);

                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.start(now);
                oscillator.stop(now + 0.08);
            } catch (error) {
                console.log("ÊªöÂä®Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•", error);
            }
        }

        function startRollingSound() {
            if (!state.soundEnabled || state.rollingSoundTimer) return;
            playRollChunk();
            state.rollingSoundTimer = window.setInterval(playRollChunk, 78);
        }

        function stopRollingSound() {
            if (state.rollingSoundTimer) {
                clearInterval(state.rollingSoundTimer);
                state.rollingSoundTimer = null;
            }
        }

        function createStars() {
            for (let i = 0; i < 52; i += 1) {
                const star = document.createElement("div");
                star.className = "star";
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 3.4}s`;
                dom.starsContainer.appendChild(star);
            }
        }

        function renderDiceEl(diceEl, value) {
            diceEl.innerHTML = "";
            diceFaces[value].forEach((cls) => {
                const dot = document.createElement("div");
                dot.className = `dot ${cls}`;
                diceEl.appendChild(dot);
            });
        }

        function refreshUI() {
            renderDiceEl(dom.dice1, state.dice1Value);

            if (state.diceCount === 2) {
                dom.dice2.classList.remove("hidden");
                renderDiceEl(dom.dice2, state.dice2Value);
            } else {
                dom.dice2.classList.add("hidden");
            }

            if (state.isRolling) {
                dom.resultText.textContent = "ÊäïÊé∑‰∏≠...";
                dom.rollButton.disabled = true;
                dom.rollButton.textContent = "üîÑ È™∞Â≠êÊªöÂä®‰∏≠...";
            } else {
                const total = state.diceCount === 1 ? state.dice1Value : state.dice1Value + state.dice2Value;
                dom.resultText.textContent = `ÊÄªËÆ°: ${total} ÁÇπ`;
                dom.rollButton.disabled = false;
                dom.rollButton.textContent = "üé≤ ÂºÄÂßãÊäïÊé∑";
                dom.resultBox.style.borderColor = total <= 3 ? "#f87171" : total <= 7 ? "#fbbf24" : "#34d399";
            }
        }

        function getCurrentProfile() {
            return voiceProfiles[state.selectedProfileIndex] || voiceProfiles[0];
        }

        function updateVoiceSelect() {
            dom.voiceSelect.innerHTML = "";
            voiceProfiles.forEach((profile, index) => {
                const option = document.createElement("option");
                option.value = String(index);
                option.textContent = `${profile.label}${profile.voice ? ` (${profile.voice.name})` : ""}`;
                if (index === state.selectedProfileIndex) {
                    option.selected = true;
                }
                dom.voiceSelect.appendChild(option);
            });
        }

        function updateVoicePreview() {
            const profile = getCurrentProfile();
            const voiceName = profile.voice ? ` / ${profile.voice.name}` : "";
            dom.voicePreview.textContent = `ÂΩìÂâçÈü≥Ëâ≤: ${profile.label}${voiceName}`;
        }

        function loadVoices() {
            if (!("speechSynthesis" in window)) {
                updateVoiceSelect();
                updateVoicePreview();
                return;
            }

            const allVoices = speechSynthesis.getVoices();
            state.availableVoices = allVoices;

            const zhVoices = allVoices.filter((voice) => {
                const text = normalizeText(`${voice.lang} ${voice.name}`);
                return /zh|cmn|yue|chinese|‰∏≠Êñá/.test(text);
            });

            const pool = zhVoices.length ? zhVoices : allVoices;
            const usedNames = new Set();

            voiceProfiles.forEach((profile) => {
                profile.voice = chooseVoiceForProfile(profile, pool, usedNames);
                if (profile.voice) {
                    usedNames.add(profile.voice.name);
                }
            });

            updateVoiceSelect();
            updateVoicePreview();
        }

        function speakText(text) {
            if (!state.voiceEnabled || !("speechSynthesis" in window)) return;

            window.speechSynthesis.cancel();
            const profile = getCurrentProfile();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "zh-CN";
            utterance.rate = profile.rate;
            utterance.pitch = profile.pitch;
            utterance.volume = profile.volume;

            if (profile.voice) {
                utterance.voice = profile.voice;
            }

            window.speechSynthesis.speak(utterance);
        }

        function refreshControls() {
            dom.soundIcon.innerHTML = state.soundEnabled ? ICONS.soundOn : ICONS.soundOff;
            dom.voiceIcon.innerHTML = state.voiceEnabled ? ICONS.voiceOn : ICONS.voiceOff;
            dom.voiceSettingsIcon.innerHTML = ICONS.settings;
            dom.themeIcon.innerHTML = state.isDarkMode ? ICONS.sun : ICONS.moon;
            dom.fullscreenIcon.innerHTML = state.isFullscreen ? ICONS.fullscreenExit : ICONS.fullscreenEnter;

            dom.soundButton.classList.toggle("is-active", state.soundEnabled);
            dom.voiceButton.classList.toggle("is-active", state.voiceEnabled);
            dom.voiceSettingsButton.classList.toggle("is-active", dom.voicePanel.classList.contains("open"));
            dom.themeButton.classList.toggle("is-active", state.isDarkMode);
            dom.fullscreenButton.classList.toggle("is-active", state.isFullscreen);
        }

        function getTotalSamples() {
            return state.distribution.reduce((sum, value) => sum + value, 0);
        }

        function renderStatsChart() {
            const values = state.distribution.slice(1);
            const maxCount = Math.max(1, ...values);
            dom.statsChart.innerHTML = "";

            for (let point = 1; point <= 12; point += 1) {
                const count = state.distribution[point];
                const ratio = count / maxCount;
                const barHeight = count === 0 ? 4 : Math.max(12, ratio * 100);

                const item = document.createElement("div");
                item.className = "stat-item";
                item.innerHTML = `
                    <span class="stat-count">${count}</span>
                    <div class="stat-track">
                        <div class="stat-bar" style="height: ${barHeight}%"></div>
                    </div>
                    <span class="stat-label">${point}</span>
                `;
                dom.statsChart.appendChild(item);
            }

            const totalSamples = getTotalSamples();
            dom.statsSummary.textContent = totalSamples > 0
                ? `Â∑≤ËÆ∞ÂΩï ${totalSamples} Ê¨°ÊäïÊé∑ÁªìÊûúÔºåÁÇπÂáª‰∏ãÊñπÂèØÈáçÁΩÆ„ÄÇ`
                : "ÊöÇÊó†ÊäïÊé∑Êï∞ÊçÆÔºåÂºÄÂßãÊäïÊé∑Âêé‰ºöËá™Âä®ÁªüËÆ°„ÄÇ";
        }

        function addDistribution(total) {
            if (total >= 1 && total <= 12) {
                state.distribution[total] += 1;
            }
            renderStatsChart();
        }

        function requestShakePermission() {
            if (state.shakePermissionGranted) return;

            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission()
                    .then((permissionState) => {
                        if (permissionState === "granted") {
                            window.addEventListener("devicemotion", handleMotion);
                            state.shakePermissionGranted = true;
                        }
                    })
                    .catch((error) => {
                        console.log("ÊëáÂä®ÊùÉÈôêÁî≥ËØ∑Â§±Ë¥•", error);
                    });
            } else {
                window.addEventListener("devicemotion", handleMotion);
                state.shakePermissionGranted = true;
            }
        }

        let lastX;
        let lastY;
        let lastZ;

        const SHAKE_THRESHOLD = 16;
        const SHAKE_COOLDOWN = 2000;

        function handleMotion(event) {
            const now = Date.now();

            if (state.isRolling || now - state.lastShakeTime < SHAKE_COOLDOWN) {
                return;
            }

            const current = event.accelerationIncludingGravity;
            if (!current) {
                return;
            }

            if (lastX !== undefined && lastY !== undefined && lastZ !== undefined) {
                const deltaX = Math.abs(current.x - lastX);
                const deltaY = Math.abs(current.y - lastY);
                const deltaZ = Math.abs(current.z - lastZ);

                if (deltaX + deltaY + deltaZ > SHAKE_THRESHOLD) {
                    state.lastShakeTime = now;
                    rollDice();
                }
            }

            lastX = current.x;
            lastY = current.y;
            lastZ = current.z;
        }

        window.toggleSound = function () {
            state.soundEnabled = !state.soundEnabled;
            if (!state.soundEnabled) {
                stopRollingSound();
            }
            refreshControls();
        };

        window.toggleVoice = function () {
            state.voiceEnabled = !state.voiceEnabled;
            if (!state.voiceEnabled && "speechSynthesis" in window) {
                window.speechSynthesis.cancel();
            }
            refreshControls();
        };

        window.toggleVoicePanel = function () {
            dom.voicePanel.classList.toggle("open");
            refreshControls();
        };

        window.changeVoice = function () {
            const index = Number(dom.voiceSelect.value);
            if (Number.isInteger(index) && index >= 0 && index < voiceProfiles.length) {
                state.selectedProfileIndex = index;
                updateVoicePreview();
            }
        };

        window.testVoice = function () {
            const profile = getCurrentProfile();
            speakText(`‰Ω†Â•ΩÔºåÊàëÊòØ${profile.label}ÔºåÁé∞Âú®ËøõË°åËØ≠Èü≥ÊµãËØï„ÄÇ`);
        };

        window.toggleTheme = function () {
            state.isDarkMode = !state.isDarkMode;
            document.body.classList.toggle("dark-mode", state.isDarkMode);
            refreshControls();
        };

        window.toggleFullscreen = async function () {
            try {
                if (!document.fullscreenElement) {
                    if (document.documentElement.requestFullscreen) {
                        await document.documentElement.requestFullscreen();
                    }
                } else if (document.exitFullscreen) {
                    await document.exitFullscreen();
                }
            } catch (error) {
                console.log("ÂÖ®Â±èÊ®°Âºè‰∏çÂèØÁî®", error);
            } finally {
                state.isFullscreen = Boolean(document.fullscreenElement);
                refreshControls();
            }
        };

        window.handleCountChange = function (event) {
            if (state.isRolling) return;
            state.diceCount = Number(event.target.value);
            state.dice1Value = Math.floor(Math.random() * 6) + 1;
            state.dice2Value = Math.floor(Math.random() * 6) + 1;
            refreshUI();
        };

        window.toggleStatsModal = function (open) {
            const shouldOpen = typeof open === "boolean" ? open : !dom.statsModal.classList.contains("open");
            dom.statsModal.classList.toggle("open", shouldOpen);
            dom.statsModal.setAttribute("aria-hidden", String(!shouldOpen));
            if (shouldOpen) {
                renderStatsChart();
            }
        };

        window.resetStats = function () {
            state.distribution.fill(0);
            renderStatsChart();
        };

        window.rollDice = function () {
            if (state.isRolling) return;

            requestShakePermission();
            state.isRolling = true;
            state.lastShakeTime = Date.now();
            refreshUI();

            startRollingSound();

            dom.dice1.classList.add("shake");
            if (state.diceCount === 2) {
                dom.dice2.classList.add("shake");
            }

            const rollDuration = 820;
            const frameInterval = 72;

            const randomizeFace = () => {
                state.dice1Value = Math.floor(Math.random() * 6) + 1;
                state.dice2Value = Math.floor(Math.random() * 6) + 1;
                renderDiceEl(dom.dice1, state.dice1Value);
                if (state.diceCount === 2) {
                    renderDiceEl(dom.dice2, state.dice2Value);
                }
            };

            randomizeFace();
            const rollTimer = setInterval(randomizeFace, frameInterval);

            setTimeout(() => {
                clearInterval(rollTimer);
                dom.dice1.classList.remove("shake");
                dom.dice2.classList.remove("shake");

                state.dice1Value = Math.floor(Math.random() * 6) + 1;
                state.dice2Value = Math.floor(Math.random() * 6) + 1;

                const total = state.diceCount === 1 ? state.dice1Value : state.dice1Value + state.dice2Value;
                addDistribution(total);

                stopRollingSound();
                state.isRolling = false;
                refreshUI();

                dom.resultBox.classList.add("bounce-in");
                setTimeout(() => dom.resultBox.classList.remove("bounce-in"), 500);

                setTimeout(() => {
                    speakText(`ÊÄªËÆ°${total}ÁÇπ`);
                }, 80);
            }, rollDuration);
        };

        dom.statsModal.addEventListener("click", (event) => {
            if (event.target === dom.statsModal) {
                toggleStatsModal(false);
            }
        });

        document.addEventListener("fullscreenchange", () => {
            state.isFullscreen = Boolean(document.fullscreenElement);
            refreshControls();
        });

        if ("speechSynthesis" in window) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        createStars();
        updateVoiceSelect();
        updateVoicePreview();
        loadVoices();
        renderStatsChart();
        refreshControls();
        refreshUI();
    </script>
</body>

</html>
